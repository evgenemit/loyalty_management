# Loyalty management system

**Loyalty management system** - это простая система управления базой данных бонусных карт.
Разработана на **Python 3** и **Django 4**

Основные возможности системы:
- Список всех бонусных карт
- Поиск карт по параметрам
- Просмотр полной информации о карте и истории заказов
- Изменение статуса карты (активация/деактивация)
- Удаление карты (в корзину/полностью)
- Генератор новых карт

Возможности API:
- Получение списка всех карт с сортировкой по всем полям
- Получение полной информации о карте, истории заказов и товаров с сортировкой
- Поиск карт по параметрам с сортировкой
- Изменение статуса карты
- Создание новой карты
- Удаление карты
- Добавление информации о новом заказе на карту


## Установка и запуск

1. Скрипт создания БД (PostgreSQL)

```bash
CREATE DATABASE loyalty_management;
CREATE USER loyalty_user WITH PASSWORD 'passfghjdehf';
ALTER ROLE loyalty_user SET client_encoding TO 'utf8';
ALTER ROLE loyalty_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE loyalty_user SET timezone TO 'Europe/Minsk';
```

2. Установка виртуального окружения

```bash
python3 -m venv venv
. venv/bin/activate
pip install -r requirements.txt
```

3. Переменные окружения

Создайте файл .env в корне проекта.

```bash
SECRET_KEY=
DEBUG=
DB_NAME=loyalty_management
DB_USER=loyalty_user
DB_PASSWORD=passfghjdehf
DB_HOST=127.0.0.1
DB_PORT=
```

4. Подготовка БД

```bash
python3 manage.py migrate
python3 manage.py loaddata loyalty_management/fixtures/data.json
```

5. Запуск

```bash
python3 manage.py runserver
```


## API

В этом разделе подробно описано использование API. Жирным шрифтом выделены обязательные параметры. Ниже приведены таблицы полей для сортировки и возможных значений статуса карты.

Некоторые ответы содержат поле **response**, которое может быть *"ok"* или *"error"*. *"ok"* означает, что запрос выполнен без ошибок. При *"error"* в ответе содержится поле **message**, в котором находится текст ошибки.

Поля для сортировки:
| Название | Описание |
| :--- | :--- |
| <название> | от меньшего к большему |
| -<название> | от большего к меньшему | 
| serial_number | Сортировка **карт** по **номеру серии** |
| number | Сортировка **карт** по **номеру** |
| date1 | Сортировка **карт** по **дате и времени выпуска** |
| date2 | Сортировка **карт** по **дате и времени окончания активности** |
| last_use | Сортировка **карт** по **дате и времени последнего использования** |
| total_sum | Сортировка **карт** по **итогой сумме** |
| status | Сортировка **карт** по **статусу** |
| discount | Сортировка **карт** по **проценту скидки** |
| discount | Сортировка **карт** по **проценту скидки** |
| number | Сортировка **заказов** по **номеру** |
| date | Сортировка **заказов** по **дате и времени** |
| order_sum | Сортировка **заказов** по **сумме заказа** |
| discount | Сортировка **заказов** по **проценту скидки** |
| discount_price | Сортировка **заказов** по **сумме скидки** |

Возможные значения для статуса карты

| Значение | Описание |
| :--- | :--- |
| 0 | Не активирована |
| 1 | Активирована |
| 2 | Просрочена |
| 3 | В корзине |

### 1. Получение списка всех карт с сортировкой по всем полям

```http
GET /api/cards/
```
| Параметр | Описание |
| :--- | :--- |
| page | Номер страницы |
| order | Название поля, по которому будет происходить сортировка |

Ответ

| Параметр | Описание |
| :--- | :--- |
| count | Количетсво записей |
| next | Ссылка на следующую страницу |
| previous | Ссылка на предыдущую страницу |
| results | Информация о картах (пример ниже) |


Пример поля **results**:
```JSON
[
    {
        "serial_number": "001",
        "number": "82957201",
        "date1": "2023-02-02T00:00:00+03:00",
        "date2": null,
        "status": 3
    },
    {
        "serial_number": "002",
        "number": "56276033",
        "date1": "2023-02-02T13:00:00+03:00",
        "date2": "2023-02-12T13:00:00+03:00",
        "status": 2
    },
    ...
]
```

### 2. Получение полной информации о карте, истории заказов и товаров с сортировкой

```http
GET /api/card/
```

| Параметр | Описание |
| :--- | :--- |
| **serial_number** | Номер серии |
| **number** | Номер карты |
| order | Название поля, по которому будет происходить сортировка заказов |

Ответ

| Параметр | Описание |
| :--- | :--- |
| response | Наличие ошибок |
| serial_number | Номер серии |
| number | Номер карты |
| date1 | Дата и время выпуска |
| date2 | дата и время окончания активности |
| last_use | Дата и время последнего использования |
| total_sum | Итоговая сумма |
| status | Статус карты |
| discount | Процент скидки |
| orders | Информация о заказах (пример ниже) |

Пример поля **orders**:
```JSON
[
    {
        "number": "675853",
        "date": "2023-02-12T15:30:31.314000+03:00",
        "order_sum": 10.58,
        "discount": 2.5,
        "discount_sum": 0.2,
        "products": [
            {
                "name": "Ананас, 1 кг",
                "price": 7.99,
                "discount_price": 0.0
            },
            {
                "name": "Шоколад молочный",
                "price": 3.39,
                "discount_price": 2.79
            }
        ]
    },
    ...
]
```

### 3. Поиск карт по параметрам с сортировкой

```http
GET /api/cards/search/
```

| Параметр | Описание |
| :--- | :--- |
| serial_number | Номер серии |
| number | Номер карты |
| date1 | Дата и время выпуска |
| date2 | дата и время окончания активности |
| status | Статус карты |
| order | Название поля, по которому будет происходить сортировка |

Ответ

| Параметр | Описание |
| :--- | :--- |
| count | Количетсво записей |
| next | Ссылка на следующую страницу |
| previous | Ссылка на предыдущую страницу |
| results | Информация о картах (пример выше) |

### 4. Изменение статуса карты

```http
POST /api/card/update-status/
```

| Параметр | Описание |
| :--- | :--- |
| **serial_number** | Номер серии |
| **number** | Номер карты |
| **status** | Новый статус карты |

Ответ

| Параметр | Описание |
| :--- | :--- |
| response | Наличие ошибок |
| serial_number | Номер серии |
| number | Номер карты |
| date1 | Дата и время выпуска |
| date2 | дата и время окончания активности |
| last_use | Дата и время последнего использования |
| total_sum | Итоговая сумма |
| status | Статус карты |
| discount | Процент скидки |

### 5. Создание новой карты

```http
POST /api/card/create/
```

| Параметр | Описание |
| :--- | :--- |
| **serial_number** | Номер серии |
| date1 | Дата и время выпуска |
| date2 | Дата и время окончания активности |
| status | Новый статус карты |
| discount | Процент скидки |

Ответ

| Параметр | Описание |
| :--- | :--- |
| response | Наличие ошибок |
| serial_number | Номер серии |
| number | Номер карты |
| date1 | Дата и время выпуска |
| date2 | дата и время окончания активности |
| last_use | Дата и время последнего использования |
| total_sum | Итоговая сумма |
| status | Статус карты |
| discount | Процент скидки |

### 6. Удаление карты

```http
POST /api/card/create/
```

| Параметр | Описание |
| :--- | :--- |
| **serial_number** | Номер серии |
| **number** | Номер карты |
| to_trash | Указывает способ удаление ("true" - в корзину, любое другое значение - полное удаление) |

Ответ

| Параметр | Описание |
| :--- | :--- |
| response | Наличие ошибок |

### 7. Добавление информации о новом заказе на карту 

```http
POST /api/order/create/
```

| Параметр | Описание |
| :--- | :--- |
| **serial_number** | Номер серии |
| **number** | Номер карты |
| **products** | Информация о товарах (пример ниже) |

Пример параметра **products**:
```JSON
[
    {
        "name": "Наименование товара",
        "price": "Цена товара",
        "discount_price": "Цена со скидкой (если скидки нет - 0)"
    },
    {
        "name": "Мандарины, 1 кг",
        "price": 12.3,
        "discount_price": 0
    },
    {
        "name": "Бананы, 1.5 кг",
        "price": 15.8,
        "discount_price": 14.3
    }
]
```

Ответ

| Параметр | Описание |
| :--- | :--- |
| response | Наличие ошибок |
| number | Номер заказа |
| date | Дата и время |
| order_sum | Сумма заказа |
| discount | Процент скидки |
| discount_sum | Сумма скидки |

